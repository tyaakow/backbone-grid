(function($){var Settings={pie:{fill_m:"#28f",fill_f:"#f82",margin:22,decimals:4},bar:{height:660,eachWidth:30},page:{length:25},items:128,partners:["John & sons ltd.","Nevada cattle ranch","Jim Prescott","Little Down Ranch","Cattle Ranch ltd.","Mexico Farm"]},Animal=Backbone.Model.extend({validate:function(animal){params=["id","name","bdate","price","weight","sex","type","partner"];for(x=0;x<8;x++)eval(params[x]+" = animal."+params[x]);directory!=undefined?ids=directory.collection.pluck("id"):ids=[];if(id=="")return"ID is required";if($.isNumeric(id)&&$("form.animalForm").attr("id")!=="EditAnimal")if(String(id).indexOf(".")!=-1||String(id).indexOf("-")!=-1||ids.indexOf(id)!=-1)return"ID: Please, enter a whole, positive, unique number";if(name=="")return"Name is required";if(Number(name)||!/^[a-zA-Z ]+$/.test(name))return"Name must contain of only alphabet caracters and a space.";if(type=="")return"type is required";if(weight!=""){if(!$.isNumeric(weight))return"Weight must be a number";if(!/^[0-9]/.test(weight))return"Weight must be a positive number";if(!/^[0-9]+\.[0-9]{2}/.test(weight))return"Weight must be a decimal number with 2 decimal spaces"}if(bdate!="")if(!/^[0-9]{1,2}\.[0-9]{1,2}\.[0-9]{4}(\.)?$/.test(bdate)||String(new Date(bdate.split(".")[1]+"/"+bdate.split(".")[0]+"/"+bdate.split(".")[2]))=="Invalid Date")return"Please enter a valid date in format dd.mm.yyyy";bdate.split(".")[0].length<2&&(animal.bdate="0"+bdate.split(".")[0]+"."+bdate.split(".")[1]+"."+bdate.split(".")[2]),bdate.split(".")[1].length<2&&(animal.bdate=bdate.split(".")[0]+"."+"0"+bdate.split(".")[1]+"."+bdate.split(".")[2]),/\.$/.test(bdate)&&(animal.bdate=bdate.replace(/\.$/,""));if(price=="")return"Price is required";if(!$.isNumeric(price))return"Price must be a number";if(!/^[0-9]/.test(price))return"Price must be a positive number";if(!/^[0-9]+\.[0-9]{2}/.test(price))return"Price must be a decimal number with 2 decimal spaces";if(sex=="")return"Sex is required";if(partner=="")return"partner is required"},initialize:function(){this.bind("error",function(e,t){$("#overlay form fieldset.root").css("border","1px dotted #f32"),alert(t)})}},{bdate:function(e){return e.getDate()>9?b_day=String(e.getDate()):b_day="0"+e.getDate(),e.getMonth()>=9?b_month=String(e.getMonth()+1):b_month="0"+(e.getMonth()+1),b_day+"."+b_month+"."+e.getFullYear()}}),Collection=Backbone.Collection.extend({model:Animal,pageSize:Settings.page.length,rlength:4,pagerLength:function(){return Math.ceil((this.length+this.pageSize)/this.pageSize)-1},paginate:function(){var e=this;return this.groupBy(function(t){return Math.ceil((1+e.indexOf(t)+e.pageSize)/e.pageSize)-1})}},{multiplyAnimals:function(){var e=Settings.items,t=[],n=["cow","bull","calf","heifer"],r=["male","female"],s=Settings.partners,o=["Milojka","Berta","Lokko","Kokolo","Bajka","Gonzo","Bikonja"];for(i=0;i<e;i++)animal={id:String(i)},animal.name=o[Math.floor(Math.random()*7)],animal.type=n[Math.floor(Math.random()*4)],animal.sex=r[Math.floor(Math.random()*2)],animal.partner=s[Math.floor(Math.random()*6)],animal_bdate=new Date(parseInt(Math.random()*18e9)+113e10),animal.bdate=Animal.bdate(animal_bdate),animal.mother=o[Math.floor(Math.random()*7)]+"_"+Math.floor(Math.random()*4),animal.price=parseInt(Math.random()*1200)+400+".00",animal.weight=parseInt(Math.random()*1e3)+200+".00",animal.farm="Farm_"+Math.floor(Math.random()*20),t.push(animal);return t},comparators:{id:function(e){return Number(e.get("id"))},d_id:function(e){return-Number(e.get("id"))},name:function(e){return e.get("name")},d_name:function(e){return String.fromCharCode.apply(String,_.map(e.get("name").split(""),function(e){return 65535-e.charCodeAt()}))},type:function(e){return e.get("type")},d_type:function(e){return String.fromCharCode.apply(String,_.map(e.get("type").split(""),function(e){return 65535-e.charCodeAt()}))},price:function(e){return Number(e.get("price"))},d_price:function(e){return-e.get("price")},weight:function(e){return Number(e.get("weight"))},d_weight:function(e){return-e.get("weight")}}}),FormView=Backbone.View.extend({template:$("#animalFormTemplate").html(),templateNew:$("#animalFormNewTemplate").html(),tagName:"div",id:"overlay",className:"animal_form_cont",render:function(){var e=_.template(this.templateNew),t=$(this.el);$("body").prepend(t).addClass("hideOverflow"),$("#overlay").hide().html(e()).fadeIn(400),$("img.close","#overlay").bind("click",function(){$("#overlay").fadeOut(800).remove(),$("body").removeClass("hideOverflow")})},renderExisting:function(){var e=_.template(this.template),t=$(this.el),n=this.model.toJSON();console.log(n.sex+typeof n.sex),n.sex=="male"?(n.m_checked="checked='checked'",n.f_checked=""):(n.f_checked="checked='checked'",n.m_checked=""),$("body").prepend(t).addClass("hideOverflow"),$("#overlay").hide().html(e(n)).fadeIn(400),$("#anim_partner option:[value='"+n.partner+"']").attr("selected","selected"),$("img.close","#overlay").bind("click",function(){$("#overlay").fadeOut(800).remove(),$("body").toggleClass("hideOverflow")})},formToJson:function(e){var t={},n=e.serializeArray();return $.each(n,function(){t[this.name]!==undefined?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},events:{"click #NewAnimal img.save":"SaveNew","click #EditAnimal img.save":"SaveExisting","click #EditAnimal img.delete":"DeleteExisting","click img.close":"QuitNew"},SaveNew:function(){var e=this,t=$("#NewAnimal"),n=new Animal;n.set(e.formToJson(t))&&(directory.collection.add(n),sort_parameter=directory.sort_parameter,page=directory.page,directory.collection.sort(),directory.render(page,sort_parameter),$("#overlay").fadeOut(800).remove(),$("body").removeClass("hideOverflow"))},SaveExisting:function(){var e=this,t=$("#EditAnimal");this.model.set(e.formToJson(t));var n=directory.sort_parameter,r=directory.page;directory.render(r,n),$("#overlay").fadeOut(800).remove(),$("body").removeClass("hideOverflow")},DeleteExisting:function(){var e=this;if(confirm("Delete this animal?")){this.model.collection.remove(this.model),this.remove();var t=directory.sort_parameter,n=directory.page;directory.render(n,t),$("#overlay").fadeOut(800).remove(),$("body").removeClass("hideOverflow")}},QuitNew:function(){$("#overlay").remove()}}),AnimalView=Backbone.View.extend({tagName:"tr",className:"animal_view",template:$("#animalTemplate").html(),formTemplate:$("#animalFormTemplate").html(),render:function(){var e=_.template(this.template);return $(this.el).html(e(this.model.toJSON())),this},events:{"click .edit":"renderEditAnimal","click .delete":"deleteAnimal"},renderEditAnimal:function(e){var t=new FormView({model:this.model});t.renderExisting()},deleteAnimal:function(e){if(confirm("Delete this animal?")){var t=this.model;t.collection.remove(t),this.remove();var n=directory.sort_parameter,r=directory.page;directory.render(r,n),directory.renderPie(directory.collection),directory.renderBars(directory.collection),$("#overlay").fadeOut(800).remove(),$("body").removeClass("hideOverflow")}}}),pageView=Backbone.View.extend({el:$("#table_container"),template:$("#animalsTemplate").html(),pagerTemplate:$("#pagerTemplate").html(),initialize:function(e,t,n){var r=this;this.sort_parameter=t,this.page=e,n==1&&(this.collection=new Collection(Collection.multiplyAnimals())),this.collection.comparator=Collection.comparators[t],this.collection.sort(),this.pagerLength=this.collection.pagerLength(),this.render(e,t)},paginate:function(){var e=this;return e.collection.groupBy(function(t){return Math.ceil((1+e.collection.indexOf(t)+e.collection.pageSize)/e.collection.pageSize)-1})},render:function(e,t){this.page=e;var n=this,r=_.template(this.template);this.$el.html(r()),_.each(this.collection.paginate()[e],function(e,t){an_view=n.renderAnimal(e),$("table.main",this.el).append(an_view.el)});var i=n.renderPager(e);$("table.main",this.el).prepend(i);var s=t;sorter=s[1]=="_"?s.split("_")[1]:s,order=s[1]=="_"?"desc":"asc",$("th."+sorter).attr("id","sortby"),$("table.main tr th p").addClass("asc"),order=="desc"&&$("th."+sorter+" p").removeClass("asc").addClass("desc"),$("th.sorting").each(function(e){var t=$(this).attr("class").split(" ")[0];$(this).attr("title","sort by "+t)}),n.renderPie(this.collection),n.renderBars(this.collection)},renderAnimal:function(e){var t=new AnimalView({model:e,id:"an_"+e.id});return t.render()},renderPie:function(e){var t=new PieView,n=t.render(e);$("#side_container").html(n.el);var r=Settings.pie.margin;$("#pieSvg").css("margin",r+" px")},renderBars:function(e){var t=new BarsView,n=t.render(e);$("#side_container").append(n.el),$(".p_bot .p_top").css({height:"0px"}),$(".p_bot").mouseenter(function(){$(".p_top",this).animate({height:$(this).height()+"px"},600)}),$(".p_bot").mouseleave(function(){$(".p_top",this).animate({height:"0px"},800)})},renderPager:function(e){var t=this,n=_.template(this.pagerTemplate),r=this.collection.pageSize,i=this.collection.rlength,s=t.pagerLength,o=e,u="<span class='nums'>",a=[];return s<5?_.each(t.paginate(),function(e,t){u+="<span class='pager_link"+(t==o?" current":"")+"'>"+t+"</span>",a.push(t)}):_.each(t.paginate(),function(e,t){t>=o-i&&t<=o+i&&(u+="<span class='pager_link"+(t==o?" current":"")+"'>"+t+"</span>",a.push(t))}),u+="</span>",a[a.length-1]<s&&(u+="<span> ... </span>"),a[0]>1&&(u="<span> ... </span>"+u),o>1?o>2?prev="<span class='pager_first' title='first page'><<</span>&nbsp;<span class='pager_prev' title='previous page'><</span>":prev="<span class='pager_first' title='first page'><<</span>":prev="",o<s?o<s-1?next="<span class='pager_last' title='last page'>>></span>&nbsp;<span class='pager_next' title='next page'>></span>":next="<span class='pager_last' title='last page'>>></span>":next="",n({prev:prev,nums:u,next:next})},events:{"click .pager_link":"pgclick","click .pager_first":"firstclick","click .pager_last":"lastclick","click .pager_prev":"prevclick","click .pager_next":"nextclick","click img.create":"NewAnimal","click table.main th.sorting":"sort"},pgclick:function(e){var t=e.currentTarget;pageRequested=Number($(t).html()),this.render(pageRequested,this.sort_parameter)},firstclick:function(e){this.render(1,this.sort_parameter)},lastclick:function(e){last=this.pagerLength,this.render(last,this.sort_parameter)},prevclick:function(e){page=this.page-1,this.render(page,this.sort_parameter)},nextclick:function(e){page=this.page+1,this.render(page,this.sort_parameter)},NewAnimal:function(e){var t=new FormView({});t.render()},sort:function(e){var t=$(e.currentTarget);th_class=t.attr("class").split(" ")[0],req_order=function(e){return toggler={asc:0,desc:1},current=e.find("p").attr("class"),["d_",""][toggler[current]]}(t),this.initialize(1,req_order+th_class,!1)}}),BarsView=Backbone.View.extend({tagName:"div",id:"barChart",className:"chart barChart",template:$("#barGraph").html(),render:function(e){var t=_.template(this.template),n="";bar_legs="",bar_legs_data="";var r=[],i=Settings.bar.height,s=$("#side_container").width(),o=s/Settings.partners.length;if(o>Math.round(Settings.bar.eachWidth*1.33))var u=Math.round(.45*o);else var u=Math.round(.7*o);var a=o-4-u;_.each(Settings.partners,function(t){Partner={},Partner.animals=e.where({partner:t}).length,Partner.partnerShare=Partner.animals/e.length,Partner.height=Math.round(i*Partner.partnerShare),Partner.title=t+" - "+Partner.animals+" animals",r.push(Partner)});var r=_.sortBy(r,function(e){return-e.animals}),f=12,l=_.max(r,function(e){return e.height}).height,c=$("#pieCont").height()+70;return _.each(r,function(e){e.bar="<div class='partner_bar p_bot' style='height: "+e.height+"px; width: "+u+"px; background: #888; left:"+f+"px; float:left;' title='"+e.title+" - "+e.animals+"'><div class='p_top' style='height: "+e.height+"px; width: "+u+"px; background: #aaa;  '></div></div>",e.leg_bar="<div class='partner_leg_bar' style='height:"+u+"px; width: "+u+"px; position:absolute; left:"+f+"px; float:left; color:#fff; font-size:90%; color:#fff;' title='"+e.title+"'>"+(_.indexOf(r,e)+1)+"</div>",e.leg_data="<div class='bar_leg_data'><p class='num'>"+(_.indexOf(r,e)+1)+"</p> "+e.title+"</div>",n+=e.bar,bar_legs+=e.leg_bar,bar_legs_data+=e.leg_data,f+=o}),$(this.el).html(t({bars:n,height:l,cont_top:120,legs:this.bar_legs,legs_data:this.bar_legs_data})).css({height:l+80,width:"100%",position:"absolute",top:c+"px"}),$(this.el).prepend("<h2 class='legend'>Partners By Number Of Animals:</h2><p class='legend'>(numbers are in the legend)</p><br /><hr />"),this}}),PieView=Backbone.View.extend({tagName:"div",id:"pieCont",className:"chart pieView",template:$("#pieSvg").html(),legendTemplate:$("#pieLegend").html(),render:function(e){var t=e.length,n=e.where({sex:"male"}).length,r=t-n,i=n/t+.25,s=r/t+.25+i,o=Math.round(n*10/t*100*Math.pow(10,2))/Math.pow(10,Settings.pie.decimals),u=Math.round(r*10/t*100*Math.pow(10,2))/Math.pow(10,Settings.pie.decimals),a=Settings.pie.fill_m,f=Settings.pie.fill_f,l=$("#side_container").width(),c=l-Settings.pie.margin*2,h=c,p=xcenter=ycenter=c/2,d=_.template(this.template),v=_.template(this.legendTemplate),m=xcenter-Math.cos(2*i*Math.PI)*p,g=ycenter-Math.sin(2*i*Math.PI)*p,y="A"+p+","+p+" 0 "+(i-.25<.5?0:1)+",1 "+m+","+g,b="M"+xcenter+","+ycenter+"L"+xcenter+","+(ycenter-p);return $(this.el).html(d({arc_path_m:y,start_path_m:b,fill_m:a,fill_f:f,svg_w:c,svg_h:h,xcenter:xcenter,ycenter:ycenter,radius:p})),$(this.el).append(v({males:n+" - or "+o+"%",females:r+" - or "+u+"%",fill_m:a,fill_f:f})),$(this.el).prepend("<h2 class='legend'>Male Female Ratio:</h2><br /><hr />"),this}}),directory=new pageView(1,"id",!0)})(jQuery);